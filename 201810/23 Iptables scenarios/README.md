23 Фильтрация трафика 20190129 [Сценарии iptables]

Домашнее задание

Сценарии iptables
1) реализовать knocking port
- centralRouter может попасть на ssh inetrRouter через knock скрипт
пример в материалах
2) добавить inetRouter2, который виден(маршрутизируется) с хоста
3) запустить nginx на centralServer
4) пробросить 80й порт на inetRouter2 8080
5) дефолт в инет оставить через inetRouter
Критерии оценки: 5 - все сделано


Топология в 23_201810_topology.png, не стал изгаляться с изысками и добавил inetRouter2 самым простым способом, хотя, можно было подключить его через centralRouter, как мне кажется, для задач этой лабы принципиально это ничего не меняет.

Для маршрутизации с хоста я использую подсеть 192.168.11.0/24

1) реализовать knocking port

Вариант 1. knockd

На inetRouter установил knockd, он слушает только на eth1 и ждет knock на 2222:tcp,3333:tcp,4444:tcp fin'ами.

Стучим самописным скриптом с использованием nmap.
Можно было использовать утилиту для knockd, но любопытно было попробовать скрипт.

На syn сложно сделать последовательность, т.к. сама система часто успевает послать хотябы один ретрансмит на порт из последовательности, поэтому плохо срабатывало, а syn+ack подручными средствами у меня не получалось послать.

Также хорошо работало с udp.

Минус в том, что для tcp fin и udp надо стучать от рута.

Но поскольку это все только чтобы попробовать в лабораторных условиях, то такой минус не критичен.
В реальных условиях можно использовать capabilities.
Хотя я бы использовал утилиту для knockd)

для подключения к inetRouter надо на centralRouter запустить скрипт

sudo /vagrant/knock.sh vagrant 192.168.255.1 2222 3333 4444
```
#!/bin/bash

# call example ./knock.sh vagrant@192.168.255.1 2222 3333 4444

USER=$1
shift
HOST=$1
shift
for ARG in "$@"
do
    # scan with fin flag to escape tcp retrasmission when using syn only
    nmap -sF --max-retries 0 -p $ARG $HOST
    # for udp knock
    #nmap -sU -Pn --max-retries 0 -p U:$ARG $HOST
done
sleep 1
ssh $USER@$HOST
```

Вариант 2. knockd на iptables

Фаервол настраиваю на centralServer.

на eth2 centralServer разрешаю отвечать на все запросы на 80й порт
Для стука использую udp, потому что ретрансмиты tcp никто не отменял, можно еще icmp использовать

для подключения к centralServer запустить с centralRouter

sudo /vagrant/knock2.sh vagrant 192.168.20.2 2222 3333 4444


2) С хоста открывается http://192.168.11.123:8080

P.S. Не проверял переживет ли стенд перезагрузку, iptables на centralServer точно не переживет
